<!doctype html>
<html>
    <head>
        <title>Mako Web Client</title>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    </head>
    <body>
        <h1>Mako Web Client</h1>
        <a id="github-login" href="#">Log in using GitHub</a>
        <div id="login-panel">
            <p>Click the link above to open a pop-up and login using GitHub.</p>
        </div>

        <script type="text/javascript">
        $(document).ready(function () {
            $('#github-login').click(function (event) {
                event.preventDefault();

                $(this).hide();

                $.ajax({
                    contentType: 'application/json',
                    data: JSON.stringify({'provider': 'github'}),
                    dataType: 'json',
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('ERROR:', textStatus, ';', errorThrown);
                    },
                    method: 'POST',
                    success: function (data) {
                        var container = $('#login-panel');

                        // must use pop-up; GitHub blocks iframes using X-Frame-Options
                        // TODO make client id configurable based on initial API call
                        var loginWindow = window.open(
                            'https://github.com/login/oauth/authorize?client_id=a546b94001f3e57686c5&state=' + 
                            data['id'], 'GitHub login');

                        window.addEventListener('message', function (event) {
                            var origin = event.origin || event.originalEvent.origin,
                                data = event.data;

                            // origin check is considered more secure 
                            // https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage
                            // TODO make origin configurable based on initial API call
                            if (origin === 'http://localhost:4000' && 
                                    data.type === 'auth:success') {
                                var params = data.params,
                                    message = $('<p></p>'),
                                    details = $('<dl></dl>');

                                message.append('Successfully authenticated!');
                                details.append('<dt>Provider</dt>');
                                details.append('<dd>' + params.provider + '</dd>');
                                details.append('<dt>Session ID</dt>');
                                details.append('<dd>' + params.id + '</dd>');
                                details.append('<dt>Token</dt>');
                                details.append('<dd>' + params.token + '</dd>');

                                container.empty();
                                container.append(message);
                                container.append(details);       

                                loginWindow.close();                        
                            }
                        }, false);
                    },
                    url: 'http://localhost:4000/auth/sessions'
                });
            });
        });
        </script>
    </body>
</html>